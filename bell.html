<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Bell</title>

<style>
body{
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  background:transparent;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

/* CLOCHE */
#bellBox{
  position:relative;
  font-size:24px;
  cursor:pointer;
  user-select:none;
}

/* BADGE */
#badge{
  position:absolute;
  top:-6px;
  right:-10px;
  background:red;
  color:white;
  font-size:11px;
  width:18px;
  height:18px;
  border-radius:50%;
  display:none;
  align-items:center;
  justify-content:center;
  font-weight:600;
}
</style>
</head>
<body>

<div id="bellBox" onclick="openNotifications()">
  ðŸ””
  <span id="badge"></span>
</div>

<script>

const SHEET_ID = "1-VbRioKfM6JHU-Oep0pa6H3S0VVuvYLyUMXTdSdRbzI";
const STORAGE_KEY = "notifications_lues";
const NOTIF_PAGE = "https://damiensiri.github.io/push2/notifications.html";

/* ===== LOCAL STORAGE ===== */

function getLues(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

/* ===== UPDATE BADGE ===== */

function updateBell(){

  fetch(`https://opensheet.elk.sh/${SHEET_ID}/notifications`)
  .then(r=>r.json())
  .then(data=>{

    const lues = getLues();
    let nonLues = 0;

    data.forEach((n,i)=>{

      // ignore expirÃ©es
      if(n.expire && new Date(n.expire) < new Date()) return;

      if(!lues.includes(i)){
        nonLues++;
      }
    });

    const badge = document.getElementById("badge");

    if(nonLues > 0){
      badge.style.display="flex";
      badge.innerText = nonLues;
    }else{
      badge.style.display="none";
    }

  })
  .catch(err=>{
    console.log("Erreur notif:",err);
  });

}

/* ===== OUVERTURE FULL SCREEN ===== */

function openNotifications(){
  window.top.location.href = NOTIF_PAGE;
}

/* ===== INIT ===== */

updateBell();
setInterval(updateBell,60000);

</script>

</body>
</html>
