<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Notifications</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f4f4f4;
}

h1{
  text-align:center;
  padding:20px 0 10px;
}

#counter{
  text-align:center;
  font-weight:600;
  margin-bottom:10px;
}

#container{
  padding:10px;
}

.notif{
  background:white;
  padding:15px;
  margin-bottom:12px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  cursor:pointer;
  transition:0.2s;
}

.notif.lu{
  opacity:0.4;
}

.notif.epingle{
  border-left:4px solid #1f5c8f;
}

.date{
  font-size:12px;
  opacity:0.6;
  margin-top:5px;
}
</style>
</head>

<body>

<h1>Notifications</h1>
<div id="counter"></div>
<div id="container"></div>

<script>

// ==========================
// CONFIG
// ==========================

const SHEET_ID = "1-VbRioKfM6JHU-Oep0pa6H3S0VVuvYLyUMXTdSdRbzI";
const STORAGE_KEY = "notifications_lues";

// ==========================
// LOCAL STORAGE
// ==========================

function getLues(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function setLues(ids){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
}

function marquerLu(id){
  const lues = getLues();
  if(!lues.includes(id)){
    lues.push(id);
    setLues(lues);
  }
}

function estLu(id){
  return getLues().includes(id);
}

// ==========================
// RESET A MINUIT
// ==========================

function nettoyerMinuit(data){
  const today = new Date().toDateString();
  const lastDay = localStorage.getItem("notif_day");

  if(lastDay !== today){

    const lues = getLues();
    const newLues = [];

    data.forEach((n,index)=>{
      if(n.epingle === "oui" && lues.includes(index)){
        newLues.push(index);
      }
    });

    setLues(newLues);
    localStorage.setItem("notif_day",today);
  }
}

// ==========================
// FETCH SHEET
// ==========================

fetch(`https://opensheet.elk.sh/${SHEET_ID}/notifications`)
.then(res => res.json())
.then(data => {

  nettoyerMinuit(data);

  const container = document.getElementById("container");
  const counter = document.getElementById("counter");

  container.innerHTML = "";

  let nonLues = 0;

  data.forEach((n,index)=>{

    // expiration
    if(n.expire && new Date(n.expire) < new Date()){
      return;
    }

    const div = document.createElement("div");
    div.className = "notif";

    // ===== ICI LE COEUR DU FIX =====
    if(estLu(index)){
      div.classList.add("lu");
    }else{
      nonLues++;
      div.setAttribute("data-unread","true");
    }

    if(n.epingle === "oui"){
      div.classList.add("epingle");
    }

    div.innerHTML = `
      <strong>${n.titre}</strong><br>
      ${n.message}
      <div class="date">${n.date || ""}</div>
    `;

    div.onclick = ()=>{
      marquerLu(index);
      div.classList.add("lu");
      div.removeAttribute("data-unread");
      updateCounter();
    };

    container.appendChild(div);
  });

  function updateCounter(){
    const totalNonLues =
      document.querySelectorAll('[data-unread="true"]').length;

    if(totalNonLues > 0){
      counter.innerHTML = totalNonLues + " notification(s) non lue(s)";
    }else{
      counter.innerHTML = "Aucune nouvelle notification";
    }
  }

  updateCounter();

});

</script>

</body>
</html>
