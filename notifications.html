<script>

/* ================= CONFIG ================= */

const SHEET_ID = "1-VbRioKfM6JHU-Oep0pa6H3S0VVuvYLyUMXTdSdRbzI";
const STORAGE_KEY = "notifications_lues";

/* ================= STORAGE ================= */

function getLues(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function setLues(ids){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
}

function marquerLu(id){
  const lues = getLues();
  if(!lues.includes(id)){
    lues.push(id);
    setLues(lues);
  }
}

function estLu(id){
  return getLues().includes(id);
}

/* ================= LOAD ================= */

fetch(`https://opensheet.elk.sh/${SHEET_ID}/notifications`)
.then(r=>r.json())
.then(data=>{

  const container = document.getElementById("container");
  const counter = document.getElementById("counter");

  container.innerHTML="";
  let nonLues = 0;

  data.forEach((n,i)=>{

    // ðŸ”´ 1 â€” on affiche UNIQUEMENT actif = oui
    if(n.actif !== "oui") return;

    // ðŸ”´ 2 â€” si date expirÃ©e on ignore
    if(n.expire && new Date(n.expire) < new Date()) return;

    const div = document.createElement("div");
    div.className="notif";

    if(estLu(i)){
      div.classList.add("lu");
    }else{
      nonLues++;
    }

    if(n.epingle==="oui"){
      div.classList.add("epingle");
    }

    div.innerHTML = `
      <strong>${n.titre}</strong><br>
      ${n.message}
      <div class="date">${n.date || ""}</div>
    `;

    div.onclick = ()=>{
      marquerLu(i);
      div.classList.add("lu");
      nonLues--;
      updateCounter();
    };

    container.appendChild(div);
  });

  function updateCounter(){
    if(nonLues>0){
      counter.innerText = nonLues+" notification(s) non lue(s)";
    }else{
      counter.innerText = "Aucune nouvelle notification";
    }
  }

  updateCounter();

});

/* ================= RETOUR ================= */

document.getElementById("backBtn").onclick = ()=>{
  window.location.href = "https://www.ce-dugrandrang.com/pwa2";
};

</script>
