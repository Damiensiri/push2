<script>

const SHEET_ID = "1-VbRioKfM6JHU-Oep0pa6H3S0VVuvYLyUMXTdSdRbzI";
const STORAGE_KEY = "notifications_lues";

/* ===== STORAGE ===== */

function getLues(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function setLues(ids){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
}

function marquerLu(id){
  const lues = getLues();
  if(!lues.includes(id)){
    lues.push(id);
    setLues(lues);
  }
}

function estLu(id){
  return getLues().includes(id);
}

/* ===== LOAD ===== */

fetch(`https://opensheet.elk.sh/${SHEET_ID}/notifications`)
.then(r=>r.json())
.then(data=>{

  const container = document.getElementById("container");
  const counter = document.getElementById("counter");

  container.innerHTML="";
  let nonLues = 0;

  data.forEach((n,i)=>{

    if(n.actif !== "oui") return;

    const div = document.createElement("div");
    div.className="notif";

    if(estLu(i)){
      div.classList.add("lu");
    }else{
      nonLues++;
    }

    if(n.epingle==="oui"){
      div.classList.add("epingle");
    }

    // Sécurisé : plus de innerHTML
    const titre = document.createElement("strong");
    titre.textContent = n.titre;

    const message = document.createElement("div");
    message.textContent = n.message;

    const date = document.createElement("div");
    date.className = "date";
    date.textContent = n.date || "";

    div.appendChild(titre);
    div.appendChild(document.createElement("br"));
    div.appendChild(message);
    div.appendChild(date);

    div.onclick = ()=>{
      marquerLu(i);
      div.classList.add("lu");
      updateCounter();
    };

    container.appendChild(div);
  });

  function updateCounter(){
    if(nonLues>0){
      counter.innerText = nonLues+" notification(s) non lue(s)";
    }else{
      counter.innerText = "Aucune nouvelle notification";
    }
  }

  updateCounter();

})
.catch(err=>{
  console.error("Erreur chargement notifications :", err);
});

</script>
